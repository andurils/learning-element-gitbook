# 3.2 å›½é™…åŒ–

### 0x00 å‰è¨€

æœ¬æ–‡å°†ç³»ç»Ÿè®²è§£ `element` å›½é™…åŒ–æ–¹æ¡ˆå®ç°,é¡¹ç›®å†…ç½®äº† 51 é—¨è¯­è¨€ã€‚`src/locale` ç›®å½•ä¸‹å­˜æ”¾äº†è¯­è¨€é…ç½®æ–‡ä»¶ã€å›½é™…åŒ–å¤„ç†æ–¹æ³•ã€æ–‡æœ¬æ ¼å¼ç­‰ï¼Œä¸‹é¢å°†é€ä¸€è®²è§£ï¼Œè€å¿ƒè¯»å®Œï¼Œç›¸ä¿¡ä¼šå¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ã€‚

### 0x01 å›½é™…åŒ–æ–¹æ¡ˆ

`element` çš„å›½é™…åŒ–æ–¹æ¡ˆæ²¡æœ‰å¼•å…¥ç¬¬ä¸‰æ–¹æ’ä»¶å¦‚ `vue-i18n`ï¼Œé€šè¿‡è‡ªå®šä¹‰å®ç°çš„ã€‚å®ƒå…¼å®¹ `vue-i18n`ï¼Œæ­é…ä½¿ç”¨èƒ½ååˆ†æ–¹ä¾¿ã€‚

#### ğŸ“ src/locale/lang

ç”¨äºå­˜æ”¾æ”¯æŒè¯­è¨€çš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤è¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡è¯­è¨€ï¼ˆzh-CNï¼‰ï¼Œ`src/locale/lang/zh-CN.js`æ–‡ä»¶è¿”å›ä¸€ä¸ª `JSON` æ ¼å¼çš„æ•°æ®ï¼Œå†…å®¹ä¸ºå„ç»„ä»¶ç›¸å…³æè¿°ç¿»è¯‘ã€‚

```js
export default {
  el: {
    // ç»„ä»¶ select é€‰æ‹©å™¨
    select: {
      loading: "åŠ è½½ä¸­",
      noMatch: "æ— åŒ¹é…æ•°æ®",
      noData: "æ— æ•°æ®",
      placeholder: "è¯·é€‰æ‹©",
    },
    // ...
  },
};
```

è‹¥éœ€è¦ä½¿ç”¨å…¶ä»–çš„è¯­è¨€ï¼Œåœ¨è¯¥ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªè¯­è¨€é…ç½®æ–‡ä»¶å³å¯ã€‚

#### ğŸ“ƒ src/locale/format.js

æä¾›å­—ç¬¦ä¸²æ¨¡æ¿å‡½æ•°,æ”¯æŒç´¢å¼•æˆ–å‘½åå…³é”®å­—å‚æ•°ã€‚ ä»£ç å®ç°å‚è€ƒ [npm/string-template](https://www.npmjs.com/package/string-template)ã€‚

```js
// æ ¸å¿ƒæ–¹æ³•

/**
 * å­—ç¬¦ä¸²æ¨¡æ¿å‡½æ•°,æ”¯æŒç´¢å¼•æˆ–å‘½åå…³é”®å­—å‚æ•°
 * @param {String} string æ¨¡æ¿å­—ç¬¦ä¸²
 * @param {Array} ...args å‚æ•°
 * @return {String}  æ ¼å¼åŒ–æ–‡æœ¬
 *
 */
function template(string, ...args) {
  const RE_NARGS = /(%|)\{([0-9a-zA-Z_]+)\}/g;
  if (args.length === 1 && typeof args[0] === "object") {
    args = args[0];
  }

  if (!args || !args.hasOwnProperty) {
    args = {};
  }

  return string.replace(RE_NARGS, (match, prefix, i, index) => {
    let result;
    if (string[index - 1] === "{" && string[index + match.length] === "}") {
      return i;
    } else {
      result = hasOwn(args, i) ? args[i] : null;
      if (result === null || result === undefined) {
        return "";
      }
      return result;
    }
  });
}
```

#### ğŸ“ƒ src/locale/index.js

`index.js`æä¾›ä¸‰ä¸ªæ–¹æ³• `use`ã€ `t`ã€ `i18n` ç”¨äºè¯­è¨€åˆ‡æ¢è®¾ç½®ã€å›½é™…åŒ–å¤„ç†ã€`i18n`æ’ä»¶å…¼å®¹ä»¥åŠè‡ªå®šä¹‰ã€‚è¯¦ç»†å†…å®¹è¯·çœ‹æ³¨é‡Šæºç ã€‚

`use` æ–¹æ³•å‚æ•°ä¸ºè¯­è¨€é…ç½®å†…å®¹ï¼Œç”¨äºè¯­è¨€åˆ‡æ¢ã€‚è‹¥å‚æ•°ä¸ºç©ºï¼Œé»˜è®¤ä½¿ç”¨ç®€ä½“ä¸­æ–‡ï¼ˆ`zh-CN`ï¼‰ã€‚

```js
import defaultLang from "element-ui/src/locale/lang/zh-CN";
let lang = defaultLang; // é»˜è®¤è¯­è¨€

// è¯­è¨€åˆ‡æ¢
export const use = function (l) {
  lang = l || lang;
};
```

`i18n` æ–¹æ³•ç”¨äºå¤–éƒ¨æ’ä»¶æ–¹æ³•çš„å…¼å®¹å’Œè‡ªå®šä¹‰å¤„ç†æ–¹æ³•å¼•å…¥ã€‚é¡¹ç›® `i18nHandler`æ–¹æ³•çš„å®ç°å°±æ˜¯ç”¨æ¥å…¼å®¹å¤–éƒ¨æ’ä»¶`vue-i18n@5.x` ã€‚

è‹¥ä¼ å…¥è‡ªå®šä¹‰å¤„ç†æ–¹æ³•ï¼Œ `i18nHandler`æ–¹æ³•å®ç°å°†è¢«è¦†ç›–ã€‚

```js
// i18nHandler æ˜¯ä¸€ä¸ª i18n çš„å¤„ç†æ–¹æ³•ï¼Œè¿™å—é€»è¾‘å°±æ˜¯ç”¨æ¥å…¼å®¹å¤–éƒ¨çš„ i18n æ–¹æ¡ˆå¦‚ vue-i18n@5.xã€‚
let i18nHandler = function () {
  // è‹¥å¼•å…¥æ’ä»¶ vue-i18n@5.xï¼Œä¼šåœ¨ Vue çš„åŸå‹ä¸ŠæŒ‚è½½ $t æ–¹æ³•ã€‚
  // i18nHandler é»˜è®¤ä¼šå°è¯•å»æ‰¾ Vue åŸå‹ä¸­çš„ $t å‡½æ•°ï¼Œ
  const vuei18n = Object.getPrototypeOf(this || Vue).$t;
  // æ–¹æ³•vuei18nå­˜åœ¨
  if (typeof vuei18n === "function" && !!Vue.locale) {
    // åˆå¹¶è¯­è¨€é…ç½®å†…å®¹
    if (!merged) {
      merged = true;
      Vue.locale(
        Vue.config.lang,
        deepmerge(lang, Vue.locale(Vue.config.lang) || {}, { clone: true })
      );
    }
    // ä½¿ç”¨vuei18nè¿›è¡Œå›½é™…åŒ–å¤„ç†
    return vuei18n.apply(this, arguments);
  }
};

// i18n çš„å¤„ç†æ–¹æ³•ï¼ˆæ”¯æŒå¼•å…¥è‡ªå®šä¹‰æ–¹æ³•ï¼‰
export const i18n = function (fn) {
  i18nHandler = fn || i18nHandler;
};
```

`t` æ–¹æ³•ç”¨äºç»„ä»¶å›½é™…åŒ–å¤„ç†ï¼Œå®ƒæ ¹æ®ä¼ å…¥çš„ `path` è·¯å¾„ï¼Œä»è¯­è¨€é…ç½®ä¸­æ‰¾åˆ°å¯¹åº”çš„æ–‡æ¡ˆï¼Œç„¶ååœ¨ç»“åˆ `options`è¿›è¡Œæ ¼å¼åŒ–å¤„ç†ã€‚

```js
// é»˜è®¤è¯­è¨€ ä¸­æ–‡ç®€ä½“
import defaultLang from "element-ui/src/locale/lang/zh-CN";
// å­—ç¬¦ä¸²æ¨¡æ¿å‡½æ•°
import Format from "./format";

// ç­‰åŒäº template() æ–¹æ³•
const format = Format(Vue);
let lang = defaultLang; // é»˜è®¤è¯­è¨€

let i18nHandler = function () {
  // ...
};

// å›½é™…åŒ–å¤„ç†æ–¹æ³•
export const t = function (path, options) {
  // ç”¨æ¥å…¼å®¹å¤–éƒ¨çš„ i18n æ–¹æ¡ˆå¦‚ vue-i18n@5.x æˆ–è‡ªå®šä¹‰æ–¹æ³•
  let value = i18nHandler.apply(this, arguments);
  // ä¼˜å…ˆä½¿ç”¨å¤–éƒ¨æ–¹æ³•
  if (value !== null && value !== undefined) return value;

  // è·¯å¾„æˆªå– è·å–å±æ€§å±‚çº§
  const array = path.split(".");
  // ç¿»è¯‘å†…å®¹
  let current = lang;

  // æ ¹æ®è·¯å¾„ä¸­å±æ€§ï¼Œå±‚çº§é€’å½’ç¿»è¯‘å†…å®¹
  for (let i = 0, j = array.length; i < j; i++) {
    const property = array[i];
    value = current[property];
    // console.log(property, value);
    if (i === j - 1) {
      // æ ¼å¼åŒ–å†…å®¹
      // value è·å–ç¿»è¯‘å†…å®¹   options ç»„ä»¶ä¼ å…¥å‚æ•°
      return format(value, options);
    }
    if (!value) return "";
    current = value;
  }
  return "";
};
```

### 0x02 ç»„ä»¶å›½é™…åŒ–å¼•ç”¨

æ¥ä¸‹æ¥é€šè¿‡`Select` ã€`Pagination`ç»„ä»¶çš„ç¤ºä¾‹è®²è§£ä¸‹å›½é™…åŒ–åŠŸèƒ½å¼•å…¥ä½¿ç”¨ã€‚

#### åŠŸèƒ½å¼•å…¥

å‰æ–‡å¯çŸ¥ `src/mixins/locale.js` å¼•å…¥`src/locale/index.js`ä¸­çš„ `t` æ–¹æ³•ï¼Œé€šè¿‡ `mixin` æ–¹å¼æä¾›ç»™ç»„ä»¶é¡µé¢ä½¿ç”¨ã€‚

```js
import { t } from "element-ui/src/locale";

export default {
  methods: {
    t(...args) {
      return t.apply(this, args);
    },
  },
};
```

`Select`ç»„ä»¶æºç ä¸­å¯ä»¥çœ‹åˆ°å›½é™…åŒ–å¤„ç†é€»è¾‘ã€‚

```js
import Locale from "element-ui/src/mixins/locale";

export default {
  mixins: [Locale],
  name: "ElSelect",
  componentName: "ElSelect",
  computed: {
    emptyText() {
      if (this.options.length === 0) {
        return this.noDataText || this.t("el.select.noData");
      }
      // ...
    },
  },
  // ...
};
```

#### t(path)

`this.t('el.select.noData')` è°ƒç”¨ `t`  æ–¹æ³•æ®ä¼ å…¥çš„ path è·¯å¾„å€¼ `el.select.noData`ï¼Œå‚æ•°`options` ä¸º `undefined` ï¼Œé»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰å¼•å…¥ç¬¬ä¸‰æ–¹æ’ä»¶æˆ–è‡ªå®šä¹‰æ–¹æ³•ï¼Œç›´æ¥ä»é»˜è®¤è¯­è¨€(ç®€ä½“ä¸­æ–‡)é…ç½®ä¸­æ‰¾åˆ°å¯¹åº”çš„æ–‡æ¡ˆ ã€‚

æ­¤æ—¶  `value`  å€¼ä¸º â€œæ— æ•°æ®â€ï¼Œå‚æ•°`options`  ä¸º â€œundefinedâ€ï¼Œä½¿ç”¨  `format`  æ–¹æ³•ï¼ˆå³  `src/locale/format.js`å®šä¹‰çš„  `template`  æ–¹æ³• ï¼‰è¿›è¡Œæ–‡æœ¬æ ¼å¼åŒ–ã€‚

```js
format('æ— æ•°æ®', undefined)  =>  'æ— æ•°æ®'
```

ç»„ä»¶æ•ˆæœå¦‚ä¸‹ ğŸ‘‡ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7436f54397a946cc95a64af0e7e7212b\~tplv-k3u1fbpfcp-watermark.image)

#### t(path, options)

åœ¨`Pagination`åˆ†é¡µç»„ä»¶ä¸­ï¼Œ `this.t('el.pagination.total', { total: this.$parent.total })` ä¼ å…¥ path è·¯å¾„å€¼ `el.pagination.total`ï¼Œå‚æ•° `options` ä¸º `{total: 1000}` ã€‚

![carbon (1).png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f0f05542b43841ac809a9cb2462a1148\~tplv-k3u1fbpfcp-watermark.image)

æ ¹æ® `el.pagination.total` è·å–å€¼ä¸º `å…± {total} æ¡`,æ˜¯ä¸€ä¸ªæ¨¡æ¿å­—ç¬¦ä¸²ã€‚

```js
{
 el: {
   pagination: {
     goto: "å‰å¾€",
     pagesize: "æ¡/é¡µ",
     total: "å…± {total} æ¡",
     pageClassifier: "é¡µ",
   },
   // ...
 }
}
```

æ­¤æ—¶ `value` å€¼ä¸º `å…± {total} æ¡`ï¼Œå‚æ•°`options` ä¸º `{total: 1000}`ï¼Œ ä½¿ç”¨ `format` æ–¹æ³•è¿›è¡Œæ–‡æœ¬æ ¼å¼åŒ–ã€‚

```js
format('å…± {total} æ¡', {total: 1000})  =>  'å…± 1000 æ¡'
```

> ä¸æ˜¯æ‰€æœ‰çš„å€¼éƒ½æ˜¯çº¯æ–‡æœ¬ï¼Œå­˜åœ¨æ¨¡æ¿å­—ç¬¦ä¸²ã€‚å¼•å…¥`src/locale/format.js`å®šä¹‰çš„ `format` æ–¹æ³•ç”¨äºå­—ç¬¦ä¸²æ ¼å¼åŒ–æ“ä½œã€‚

ç»„ä»¶æ•ˆæœå¦‚ä¸‹ ğŸ‘‡ã€‚

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/500caa63899048f9a0a8bdc9c5a8dbbf\~tplv-k3u1fbpfcp-watermark.image)

### 0x03 é¡¹ç›®å›½é™…åŒ–è®¾ç½®

é€šè¿‡ä¸Šè¿°ç¯‡å¹…è¯¦ç»†è®¨è®ºç»„ä»¶å†…éƒ¨å›½é™…åŒ–æ–¹æ¡ˆå®ç°ã€‚æ¥ä¸‹æ¥ä»‹ç»ç»„ä»¶çš„ä½¿ç”¨ä¸­å¦‚ä½•ä½¿ç”¨è®¾ç½®å¤šè¯­è¨€ï¼Œå¼•å…¥ç¬¬ä¸‰æ–¹æ’ä»¶ã€æ‰‹åŠ¨æ‰©å±•æ–¹æ³•ç­‰æ“ä½œã€‚

#### å®Œæ•´å¼•å…¥

ä½¿ç”¨ `Vue.use()`å…¨å±€æ³¨å†Œç»„ä»¶æ—¶ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ªå¯é€‰çš„é€‰é¡¹å¯¹è±¡ï¼Œ`locale` ç”¨äºè¯­è¨€è®¾ç½®ã€`i18n` è‡ªå®šä¹‰ i18n çš„å¤„ç†æ–¹æ³• ã€‚

```js
import Vue from "vue";
import ElementUI from "element-ui";
import lang from "element-ui/lib/locale/lang/en";

import "element-ui/lib/theme-chalk/index.css";

Vue.use(ElementUI, {
  locale: lang,
  i18n: function (path, options) {
    // ...
  },
});
```

`src/index.js` ä¸­çš„ `install` æ–¹æ³•ä¸­æä¾› `locale.use()` ã€ `locale.i18n()` ï¼Œæ¥æ”¶å‚æ•° `opts`,ç”¨äºå›½é™…åŒ–å…¨å±€è®¾ç½®ã€‚

```js
import locale from "element-ui/src/locale";
// ...

const install = function (Vue, opts = {}) {
  locale.use(opts.locale);
  locale.i18n(opts.i18n);
  // ...
};
```

#### æŒ‰éœ€å¼•å…¥

å¼•å…¥éƒ¨åˆ†ç»„ä»¶æ¯”å¦‚  `Button`  å’Œ`Select`ï¼Œå¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹å¼è¿›è¡Œæ³¨å†Œï¼šæ’ä»¶æ³¨å†Œ  `Vue.use()`  æˆ– ç»„ä»¶å…¨å±€æ³¨å†Œ`Vue.component()`ï¼›å¼•å…¥  `locale`  æ–¹æ³•è®¾ç½®è¯­è¨€;å¼•å…¥  `i18n`  æ–¹æ³•ç”¨äºå¤„ç†æ–¹æ³•;ã€‚

```js
import Vue from "vue";
import { Button, Select, locale, i18n } from "element-ui";
import lang from "element-ui/lib/locale/lang/en";
// import locale from 'element-ui/lib/locale'

import "element-ui/lib/theme-chalk/index.css";

// è®¾ç½®è¯­è¨€  ç­‰åŒäº locale.use()
locale(lang);

// è®¾ç½®i18nå¤„ç†æ–¹æ³•  ç­‰åŒäº  locale.i18n()
i18n(function (path, options) {
  // ...
});

// å¼•å…¥ç»„ä»¶
Vue.use(Button);
Vue.component(Select.name, Select);
```

`src/index.js` ä¸­å¯¼å‡ºçš„ `locale` ã€ `i18n`æ–¹æ³•ã€‚ `locale` ç­‰åŒäº`locale.use`ï¼Œ `i18n` ç­‰åŒäº`locale.i18n`ã€‚

```js
import locale from "element-ui/src/locale";
// ...

const install = function (Vue, opts = {}) {
  // ...
};

export default {
  locale: locale.use,
  i18n: locale.i18n,
  install,
  Button,
  Select,
  // ...
};
```

#### æ­é…`vue-i18n`ä½¿ç”¨

é¡¹ç›®ä¹Ÿå¯å¼•å…¥ç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œå¦‚`vue-i18n`ï¼Œæœ€æ–°ç‰ˆæœ¬ä¸º `8.x` ï¼Œä½¿ç”¨éœ€è¦æ‰‹åŠ¨å¤„ç† (`Element` å…¼å®¹ `5.x`) ã€‚

```js
import Vue from "vue";
import Element from "element-ui";
import VueI18n from "vue-i18n";
import enLocale from "element-ui/lib/locale/lang/en";
import zhLocale from "element-ui/lib/locale/lang/zh-CN";

Vue.use(VueI18n);

const messages = {
  en: {
    message: {
      hello: "hello world",
    },
    ...enLocale, // æˆ–è€…ç”¨ Object.assign({ message: {hello: "hello world"}} }, enLocale)
  },
  zh: {
    message: {
      hello: "ä½ å¥½ä¸–ç•Œ",
    },
    ...zhLocale, // æˆ–è€…ç”¨ Object.assign({ message: {hello: "ä½ å¥½ä¸–ç•Œ"} }, zhLocale)
  },
};

// åˆ›å»º VueI18n å®ä¾‹
const i18n = new VueI18n({
  locale: "zh", // è®¾ç½®è¯­è¨€
  messages, // è¯­è¨€ç¿»è¯‘å†…å®¹
});

//æ³¨å†ŒElement  è‡ªå®šä¹‰i18n çš„å¤„ç†æ–¹æ³•
Vue.use(Element, {
  i18n: (key, value) => i18n.t(key, value),
});

new Vue({
  i18n,
  render: (h) => h(App),
}).$mount("#app");
```

æµ‹è¯•é¡µé¢

```html
<template>
  <div id="app">
    <div>message.hello -- {{ $t("message.hello") }}</div>
    <div>el.select.noData -- {{ $t("el.select.noData") }}</div>
  </div>
</template>

<script>
  export default {
    name: "App",
  };
</script>
```

è®¾ç½®è¯­è¨€ä¸º`zh`ï¼Œ é¡µé¢è¾“å‡ºå†…å®¹ï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a40b3bc68190411da625b82a0b5b5564\~tplv-k3u1fbpfcp-watermark.image)

è®¾ç½®è¯­è¨€ä¸º`en`ï¼Œ é¡µé¢è¾“å‡ºå†…å®¹ï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8b14b6d7d4f74f5ba558a52060040edf\~tplv-k3u1fbpfcp-watermark.image)
